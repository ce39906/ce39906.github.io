<html>
<head>
    <meta charset="utf-8" />
<meta name="description" content="" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<title>Leveldb BloomFilter 解析 | Ce39906&#39;s Blog</title>

<link rel="shortcut icon" href="https://ce39906.github.io//favicon.ico?v=1611754037346">

<link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://ce39906.github.io//styles/main.css">
<!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/css/bootstrap.min.css"> -->

<style>
    hr {
        margin-top: 1rem;
        margin-bottom: 1rem;
        border: 0;
        border-top: 1px solid rgba(0, 0, 0, 0.1);
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets/highlight.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.15.10/languages/dockerfile.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.15.10/languages/dart.min.js"></script>

<!-- <script src="https://cdn.jsdelivr.net/npm/moment@2.27.0/moment.min.js"></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/js/bootstrap.min.js"></script> -->
<!-- DEMO JS -->
<!--<script src="media/scripts/index.js"></script>-->


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.css">
</head>
<body>
<div class="main gt-bg-theme-color-first">
    <style>
    /* 导航栏样式 */
    .navbar {
        position: relative;
        display: -ms-flexbox;
        display: flex;
        -ms-flex-wrap: wrap;
        flex-wrap: wrap;
        -ms-flex-align: center;
        align-items: center;
        -ms-flex-pack: justify;
        justify-content: space-between;
        padding: 0.5rem 1rem;
    }

    .navbar-brand {
        display: inline-block;
        padding-top: 0.3125rem;
        padding-bottom: 0.3125rem;
        margin-right: 1rem;
        font-size: 1.25rem;
        line-height: inherit;
        white-space: nowrap;
    }

    .navbar-brand:hover,
    .navbar-brand:focus {
        text-decoration: none;
    }

    .navbar-nav {
        display: -ms-flexbox;
        display: flex;
        -ms-flex-direction: column;
        flex-direction: column;
        padding-left: 0;
        margin-bottom: 0;
        list-style: none;
    }

    .navbar-collapse {
        -ms-flex-preferred-size: 100%;
        flex-basis: 100%;
        -ms-flex-positive: 1;
        flex-grow: 1;
        -ms-flex-align: center;
        align-items: center;
    }

    .navbar-toggler {
        padding: 0.25rem 0.75rem;
        font-size: 1.25rem;
        line-height: 1;
        background-color: transparent;
        border: 1px solid transparent;
        border-radius: 0.25rem;
    }

    .navbar-toggler:hover,
    .navbar-toggler:focus {
        text-decoration: none;
    }

    @media (min-width: 992px) {
        .navbar-expand-lg {
            -ms-flex-flow: row nowrap;
            flex-flow: row nowrap;
            -ms-flex-pack: start;
            justify-content: flex-start;
        }

        .navbar-expand-lg .navbar-nav {
            -ms-flex-direction: row;
            flex-direction: row;
        }

        .navbar-expand-lg .navbar-collapse {
            display: -ms-flexbox !important;
            display: flex !important;
            -ms-flex-preferred-size: auto;
            flex-basis: auto;
        }

        .navbar-expand-lg .navbar-toggler {
            display: none;
        }
    }

    @media (max-width: 991px) {
        #navbarSupportedContent {
            display: none;
        }
    }
</style>
<nav class="navbar navbar-expand-lg">
    <div class="navbar-brand">
        <img class="user-avatar" src="/images/avatar.png" alt="头像">
        <div class="site-name gt-c-content-color-first">
            Ce39906&#39;s Blog
        </div>
    </div>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <i class="fas fa-bars gt-c-content-color-first" style="font-size: 18px"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <div class="navbar-nav mr-auto" style="text-align: center">
            
            <div class="nav-item">
                
                <a href="/" class="menu gt-a-link">
                    首页
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="/archives" class="menu gt-a-link">
                    归档
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="/tags" class="menu gt-a-link">
                    标签
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="/post/about" class="menu gt-a-link">
                    关于
                </a>
                
            </div>
            
        </div>
        <div style="text-align: center">
            <form id="gridea-search-form" style="position: relative" data-update="1611754037346"
                action="/search/index.html">
                <input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="搜索文章" />
                <i class="fas fa-search gt-c-content-color-first" style="position: absolute; top: 9px; left: 10px;"></i>
            </form>
        </div>
    </div>
</nav>
<script>
    /* 移动端导航栏展开/收起切换 */
    document.getElementById('changeNavbar').onclick = function () {
        var element = document.getElementById('navbarSupportedContent');
        if (element.style.display === 'none' || element.style.display === '') {
            element.style.display = 'block';
        } else {
            element.style.display = 'none';
        }
    }
</script>
    <div class="post-container">
        <div class="post-detail gt-bg-theme-color-second">
            <article class="gt-post-content">
                <h2 class="post-title">
                    Leveldb BloomFilter 解析
                </h2>
                <div class="post-info">
                    <time class="post-time gt-c-content-color-first">
                        · 2018-04-28 ·
                    </time>
                    
                        <a href="https://ce39906.github.io//tag/sKN_FIXf8-e" class="post-tags">
                            # Leveldb
                        </a>
                    
                </div>
                <div class="post-content">
                    <p>一个设计的非常巧妙的数据结构</p>
<!-- more -->
<h2 id="bloomfilter-原理">BloomFilter 原理</h2>
<p>布隆过滤器由巴顿布隆于1970年提出，由一个很长的bit数组以及一系列hash函数组成。bloomfilter可以用于检索一个元素是否出现在一个集合中，bloomfilter的优点是相比hash表拥有极大的空间效率，缺点是会出现一定的错误概率(False positive,一个不在集合中的元素被误认为处于集合中）。<br>
bloomfilter 的原理是，当一个元素在加入集合时，通过k个hash 函数映射到bit数组的k个位置，并将相应的位置置1。在查找一个元素是否存在于集合中时，使用相同的k个hash 函数查看bit数组中的位置是否为全为1，如果出现一个0，则该key 一定不存在集合中，否则有可能出现在集合中。</p>
<h3 id="优点">优点</h3>
<p>Bloomfilter 可以使用较少的空间存储大量数据的全集，并且存储的不是每个元素的原本的数值，只是设置对应的bit位，一定程度上实现了加密的效果。除空间效率之外，bloomfilter的时间效率都是常数级别O(k),其中k 代表使用的hash 函数个数，由于k个hash 函数式相互独立的性质，在进行k个hash 计算时可以并行计算进一步加速插入查找。</p>
<h3 id="缺点">缺点</h3>
<p>Bloomfilter 的缺点是会出现False positive 的误判率，而且随着元素的增加，误算率也随之增加。因此尽可能降低误判率需要一些额外工作。</p>
<h3 id="bloomfilter参数选择">BloomFilter参数选择</h3>
<p>以下均参考wikipedia <a href="https://en.wikipedia.org/wiki/Bloom_filter">bloomfilter</a> 中关于误差率的计算章节。直接说结论，当k(hash 函数个数)，m(bit数组大小)，n(插入元素个数)满足下式的时候，可以保证最低的误差率。$$k=\cfrac{m}{n}ln2$$下图(摘自wikipedia) 表示在最优hash函数个数的情况下，不同m,n之间误差率关系。</p>
<p><img src="https://upload.wikimedia.org/wikipedia/commons/e/ef/Bloom_filter_fp_probability.svg" width=450 height=360/>从上图可以看到当存储10亿个元素时使用4GB的存储空间可以保证不到1e-06的错误率。可以看到bloomfilter在实现高空间利用率的同时可以保证较低误差率。</p>
<h2 id="leveldb-实现">Leveldb 实现</h2>
<p>leveldb bloomfilter 实现在util/bloom.cc</p>
<h3 id="成员变量以及构造函数">成员变量以及构造函数</h3>
<pre><code>class BloomFilterPolicy : public FilterPolicy {
 private:
  // 平均每个key拥有的bit 数目
  size_t bits_per_key_;
  // hash function 的个数
  size_t k_;

 public:
  explicit BloomFilterPolicy(int bits_per_key)
      : bits_per_key_(bits_per_key) {
    // We intentionally round down to reduce probing cost a little bit
    // 按照上面的公式设定hash函数的个数
    k_ = static_cast&lt;size_t&gt;(bits_per_key * 0.69);  // 0.69 =~ ln(2)
    if (k_ &lt; 1) k_ = 1;
    if (k_ &gt; 30) k_ = 30;
  }
 };
</code></pre>
<h3 id="createfilter">CreateFilter</h3>
<p>将传入的n个key 存储到bloomfilter 中，bloomfilter结果使用string存储。</p>
<pre><code>virtual void CreateFilter(const Slice* keys, int n, std::string* dst) const {
    // Compute bloom filter size (in both bits and bytes)
    // bloomfilter 需要多少bit
    size_t bits = n * bits_per_key_;

    // For small n, we can see a very high false positive rate.  Fix it
    // by enforcing a minimum bloom filter length.
    if (bits &lt; 64) bits = 64;
    // 对齐,方便内存读写以及后续位置索引
    size_t bytes = (bits + 7) / 8;
    bits = bytes * 8;
	// 在string 中分配空间
    const size_t init_size = dst-&gt;size();
    dst-&gt;resize(init_size + bytes, 0);
    // string 的最后一个byte存储使用的hash 函数的个数
    dst-&gt;push_back(static_cast&lt;char&gt;(k_));  // Remember # of probes in filter
    // 获得string内部的char 型数组
    char* array = &amp;(*dst)[init_size];
    // 逐个将每个key 写入bloom fliter
    for (int i = 0; i &lt; n; i++) {
      // Use double-hashing to generate a sequence of hash values.
      // See analysis in [Kirsch,Mitzenmacher 2006].
      // leveldb 使用一个hash 函数，每次对hash值向右循环移位17个bit来模拟实现多个hash 函数的效果
      uint32_t h = BloomHash(keys[i]);
      // 每次向右循环移位17个bit
      const uint32_t delta = (h &gt;&gt; 17) | (h &lt;&lt; 15);  // Rotate right 17 bits
      for (size_t j = 0; j &lt; k_; j++) {
        // 在整个bit 数组的位置
        const uint32_t bitpos = h % bits;
        // 在char型数组的位置
        array[bitpos/8] |= (1 &lt;&lt; (bitpos % 8));
        // 更新获得一个新的hash 数值
        h += delta;
      }
    }
  }
</code></pre>
<h3 id="keymaymatch">KeyMayMatch</h3>
<p>判断一个 key 在bloomfilter中是否存在。</p>
<pre><code> virtual bool KeyMayMatch(const Slice&amp; key, const Slice&amp; bloom_filter) const {
    const size_t len = bloom_filter.size();
    if (len &lt; 2) return false;

    const char* array = bloom_filter.data();
    // 最后一个byte数值代表使用了多少hash函数
    // 除最后一个byte之外代表bit数组
    const size_t bits = (len - 1) * 8;

    // Use the encoded k so that we can read filters generated by
    // bloom filters created using different parameters.
    const size_t k = array[len-1];
    if (k &gt; 30) {
      // Reserved for potentially new encodings for short bloom filters.
      // Consider it a match.
      return true;
    }
	// 使用相同的方法模拟多个hash函数计算的hash值
    uint32_t h = BloomHash(key);
    const uint32_t delta = (h &gt;&gt; 17) | (h &lt;&lt; 15);  // Rotate right 17 bits
    for (size_t j = 0; j &lt; k; j++) {
      const uint32_t bitpos = h % bits;
      // 找到一个bit位置不匹配，提前返回false
      // 在bit数组中位置的索引和设置时的方法一致
      if ((array[bitpos/8] &amp; (1 &lt;&lt; (bitpos % 8))) == 0) return false;
      // 更新获得下一个hash value
      h += delta;
    }
    // 全部匹配return true
    return true;
  }
</code></pre>
<h2 id="bloomfilter-应用场景">BloomFilter 应用场景</h2>
<p>由于其高效的空间效率，bloomfilter 可以应用于以下场景：</p>
<ul>
<li>爬虫系统记录以经爬取过的url</li>
<li>垃圾邮件过滤</li>
<li>p2p 网络中查找资源操作: 使用一个bloomfilter 保存拥有此资源的网络通路</li>
<li>广播信息时检查某个ip是否发包</li>
<li>字典纠错：将所有单词存储到bloomfilter中，如果不存在则认为是一个错误拼写</li>
<li>CDN 代理缓存: 每个cache 服务器上使用bloomfilter 存储兄弟cache 服务器上是否有缓存关键字，如果没有则可以避免一次查找</li>
</ul>
<h2 id="总结">总结</h2>
<p>Bloomfilter 是一种设计巧妙的数据结构，由于其良好的空间效率，可以用于判断一个元素是否包含于海量元素集合的场景。<br>
Leveldb 的实现的bloomfilter 可以灵活配置hash 函数的个数，使用一个hash 函数模拟任意多个hash 函数的场景，并将使用hash函数的个数存储到bloomfilter编码结果中。除此之外，leveldb bloomfilter 实现bit数组个数，hash函数个数以及存储元素个数的最优配置，保证最低的误差率。</p>

                </div>
            </article>
        </div>

        
            <div class="next-post">
                <div class="next gt-c-content-color-first">下一篇</div>
                <a href="https://ce39906.github.io//post/Leveldb-skiplist-实现以及解析" class="post-title gt-a-link">
                    Leveldb skiplist 实现以及解析
                </a>
            </div>
        

        

        

        

        <div class="site-footer gt-c-content-color-first">
    <div class="slogan gt-c-content-color-first">算法及读书杂记</div>
    <div class="social-container">
        
            
        
            
        
            
        
            
        
            
        
            
        
    </div>
    <div class="footer-info">
        
    </div>
    <div>
        Theme by <a href="https://imhanjie.com/" target="_blank">imhanjie</a>, Powered by <a
                href="https://github.com/getgridea/gridea" target="_blank">Gridea | <a href="https://ce39906.github.io//atom.xml" target="_blank">RSS</a></a>
    </div>
</div>

<script>
  hljs.initHighlightingOnLoad()
</script>

    </div>
</div>
</body>
</html>
